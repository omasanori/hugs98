# @configure_input@
################################################################
# Conversion of libraries from raw sources in the fptools tree
# (this should be a POSIX 1003.2-1992 Makefile)
################################################################

@MkDefs@

# We use the autoconf-supplied install-sh to create directories
# but use /bin/cp to copy data because install-sh can't copy
# multiple files at once.

INSTALL		= ../install-sh
INSTALL_DATA	= /bin/cp
CPPFLAGS	= -D__HUGS__ -D$(HOST_OS)_HOST_OS -D$(HOST_OS)_TARGET_OS

BUILD_DIR	= ../hugsdir

HEADERS		= ../src/HsFFI.h
FP_HEADERS	= ../src/platform.h include/MachDeps.h include/ghcconfig.h
CPPHS_SRC	= ../cpphs
HSC2HS_SRC	= ../fptools/ghc/utils/hsc2hs

# a file created by make include
INCLUDES	= $(BUILD_DIR)/include/HsFFI.h

# We use a bootstrap procedure to construct the libraries:
#
# 1. Preprocess hugsbase, base, haskell98 and Cabal into bootlibs
#    using the shell script make_bootlib.  The result is incomplete,
#    in particular because hsc2hs wasn't available yet, but it's enough
#    to get ffihugs, runhugs, cpphs, hsc2hs and Cabal working,
#
# 2. Build all the packages into ../hugsdir, using cpphs, hsc2hs and Cabal.
#
# Unfortunately that means building (and configuring) base twice.

CPPHS		= tools/cpphs
HSC2HS		= tools/hsc2hs
CPPHS_FILE	= $(CPPHS)$(BAT)
HSC2HS_FILE	= $(HSC2HS)$(BAT)
MAKE_BOOT	= tools/make_bootlib
CONVERT		= tools/convert_libraries
BOOTLIB		= bootlib/.stamp

all: $(BUILD_DIR)/.stamp

$(BUILD_DIR)/.stamp: bootlib/.stamp $(INCLUDES) $(CPPHS_FILE) $(HSC2HS_FILE) $(CONVERT)
	$(RM) -r $(BUILD_DIR)/libraries $(BUILD_DIR)/packages $(BUILD_DIR)/oldlib
	cd ..; HOST='$(HOST)' libraries/$(CONVERT) fptools hugsdir
	echo timestamp for libraries >$@

$(HSC2HS): $(BUILD_DIR)/programs/hsc2hs/Main.hs
	(echo '#! /bin/sh'; \
	 echo "rootdir='`cd ..; pwd`'"; \
	 echo '$$rootdir/src/runhugs -P$$rootdir/libraries/bootlib $$rootdir/hugsdir/programs/hsc2hs/Main.hs -I$$rootdir/hugsdir/include "$$@"') >$@
	chmod 755 $@

$(HSC2HS).bat: $(BUILD_DIR)/programs/hsc2hs/Main.hs
	(echo '@echo off'; \
	 echo "set rootdir=`cd ..; src/runhugs -Plibraries/bootlib libraries/pwd.hs`"; \
	 echo '%rootdir%/src/runhugs -P%rootdir%/libraries/bootlib %rootdir%/hugsdir/programs/hsc2hs/Main.hs -I%rootdir%/hugsdir/include %*') >$@

$(BUILD_DIR)/programs/hsc2hs/Main.hs: $(HSC2HS_SRC)/Main.hs $(BOOTLIB) $(INCLUDES) $(CPPHS_FILE)
	mkdir -p $(BUILD_DIR)/programs/hsc2hs
	../src/runhugs -Pbootlib $(BUILD_DIR)/programs/cpphs/Main.hs $(CPPFLAGS) --noline --strip $(HSC2HS_SRC)/Main.hs -O$(BUILD_DIR)/programs/hsc2hs/Main.hs
	cp $(HSC2HS_SRC)/template-hsc.h $(BUILD_DIR)/programs/hsc2hs

$(CPPHS): $(BUILD_DIR)/programs/cpphs/Main.hs
	(echo '#! /bin/sh'; \
	 echo "rootdir='`cd ..; pwd`'"; \
	 echo '$$rootdir/src/runhugs -P$$rootdir/libraries/bootlib $$rootdir/hugsdir/programs/cpphs/Main.hs "$$@"') >$@
	chmod 755 $@

$(CPPHS).bat: $(BUILD_DIR)/programs/cpphs/Main.hs
	(echo '@echo off'; \
	 echo "set rootdir=`cd ..; src/runhugs -Plibraries/bootlib libraries/pwd.hs`"; \
	 echo '%rootdir%/src/runhugs -P%rootdir%/libraries/bootlib %rootdir%/hugsdir/programs/cpphs/Main.hs %*') >$@

$(BUILD_DIR)/programs/cpphs/Main.hs: $(BOOTLIB)
	mkdir -p $(BUILD_DIR)/programs/cpphs
	cp $(CPPHS_SRC)/*.hs $(BUILD_DIR)/programs/cpphs
	cd $(BUILD_DIR)/programs/cpphs; mv cpphs.hs Main.hs

$(BOOTLIB): hugsbase/Hugs/*.* $(MAKE_BOOT) $(INCLUDES)
	CPPFLAGS='$(CPPFLAGS)' $(MAKE_BOOT)
	echo timestamp for bootlib >$@

$(INCLUDES): $(HEADERS)
	mkdir -p $(BUILD_DIR)/include
	$(CP) $(HEADERS) $(BUILD_DIR)/include
	mkdir -p ../fptools/ghc/includes
	$(CP) $(FP_HEADERS) ../fptools/ghc/includes

clean:
	$(RM) LibStatus
	$(RM) a.out
	$(RM) *~
	$(RM) -r bootlib
	$(RM) hugsbase/.installed-pkg-config
	$(RM) ../fptools/libraries/*/.installed-pkg-config
	find ../fptools/libraries -name \*.hsc | sed 's/c$$//' | xargs $(RM)
	$(RM) -r ../fptools/ghc/includes
# package configuration is part of the build process, so clean it here
	$(RM) hugsbase/.setup-config
	$(RM) ../fptools/libraries/*/.setup-config
	$(RM) ../fptools/libraries/*/config.log
	$(RM) ../fptools/libraries/*/config.status
	$(RM) -r ../fptools/libraries/*/autom4te.cache
	$(RM) -r ../fptools/libraries/HaXml/obj
	find ../fptools/libraries -name \*.in | sed 's/\.in$$//' | xargs $(RM)

distclean: clean
	$(RM) -r $(BUILD_DIR)
	$(RM) config.log config.status
	$(RM) -r autom4te.cache
	$(RM) include/ghcconfig.h
	$(RM) Makefile
	$(RM) tools/config
	$(RM) tools/cpphs
	$(RM) tools/hsc2hs

veryclean: distclean

install: all
	$(INSTALL) -d $(DESTDIR)$(hugsdir)/include
	$(INSTALL_DATA) $(BUILD_DIR)/include/* $(DESTDIR)$(hugsdir)/include
	$(INSTALL) -d $(DESTDIR)$(hugsdir)/oldlib
	$(INSTALL_DATA) $(BUILD_DIR)/oldlib/* $(DESTDIR)$(hugsdir)/oldlib
	(cd $(BUILD_DIR); find libraries -type f -print) | while read file;\
		do	dir=`dirname $$file`;\
			case $$file in \
			*.hs|*.lhs|*.so|*.dll) \
				$(INSTALL) -d $(DESTDIR)$(hugsdir)/$$dir;\
				$(INSTALL) -c -m 0644 $(BUILD_DIR)/$$file $(DESTDIR)$(hugsdir)/$$file ;;\
			esac;\
		done
	(cd $(BUILD_DIR); find packages -type f -print) | while read file;\
		do	dir=`dirname $$file`;\
			case $$file in \
			*.c)	;;\
			*) \
				$(INSTALL) -d $(DESTDIR)$(hugsdir)/$$dir;\
				$(INSTALL) -c -m 0644 $(BUILD_DIR)/$$file $(DESTDIR)$(hugsdir)/$$file;;\
			esac;\
		done
	(cd $(BUILD_DIR); find demos -type f -print) | while read file;\
		do	dir=`dirname $$file`;\
			$(INSTALL) -d $(DESTDIR)$(hugsdir)/$$dir;\
			$(INSTALL) -c -m 0644 $(BUILD_DIR)/$$file $(DESTDIR)$(hugsdir)/$$file;\
		done
	(cd $(BUILD_DIR); find programs -type f -print) | while read file;\
		do	dir=`dirname $$file`;\
			$(INSTALL) -d $(DESTDIR)$(hugsdir)/$$dir;\
			$(INSTALL) -c -m 0644 $(BUILD_DIR)/$$file $(DESTDIR)$(hugsdir)/$$file;\
		done
	(echo '#! /bin/sh'; \
	 echo 'runhugs $(hugsdir)/programs/cpphs/Main.hs "$$@"') >$(DESTDIR)$(bindir)/cpphs-hugs
	chmod 755 $(DESTDIR)$(bindir)/cpphs-hugs
	(echo '#! /bin/sh'; \
	 echo 'runhugs $(hugsdir)/programs/hsc2hs/Main.hs -I$(hugsdir)/include "$$@"') >$(DESTDIR)$(bindir)/hsc2hs-hugs
	chmod 755 $(DESTDIR)$(bindir)/hsc2hs-hugs

LibStatus: all
	tools/test_libraries ../fptools >$@
